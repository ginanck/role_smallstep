#!/usr/bin/env bash

# Config
CA_CERT="root_ca.crt"
ROOTS_URL="{{ smallstep_ca_server_url }}/roots.pem"

echo "[*] Downloading root CA certificate..."
echo "[*] Downloading from: $ROOTS_URL"

set -e

# Download the root CA certificate to current directory
curl -k -o "$CA_CERT" "$ROOTS_URL"
echo "[*] Certificate downloaded to: $CA_CERT"

# Install to system trust store
echo "[*] Installing CA to macOS system keychain..."
sudo security add-trusted-cert -d -r trustRoot -k /Library/Keychains/System.keychain "$CA_CERT"

echo "[*] Cleaning up downloaded certificate file..."
rm "$CA_CERT"

echo "[âœ“] Done! CA is trusted system-wide."
echo "[*] Certificate file remains at: $CA_CERT"
