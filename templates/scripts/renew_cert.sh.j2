#!/bin/bash
# {{ ansible_managed }}

set -e

CERT_NAME="{{ cert_item.name }}"
CERT_DIR="{{ smallstep_www_certs_dir }}/{{ cert_item.name }}"
STEPPATH="{{ smallstep_bin_dir }}/ca"
CA_URL="https://{{ smallstep_ca_dns | default('ca.internal.local') }}:{{ smallstep_ca_port | default('443') }}"

export STEPPATH

echo "Renewing certificate for ${CERT_NAME}..."

# Renew the certificate
step ca renew \
    "${CERT_DIR}/${CERT_NAME}.crt" \
    "${CERT_DIR}/${CERT_NAME}.key" \
    --ca-url "${CA_URL}" \
    --force

# Recreate fullchain certificate
cat "${CERT_DIR}/${CERT_NAME}.crt" \
    "{{ smallstep_bin_dir }}/ca/certs/intermediate_ca.crt" \
    "{{ smallstep_bin_dir }}/ca/certs/root_ca.crt" \
    > "${CERT_DIR}/${CERT_NAME}-fullchain.crt"

echo "Certificate renewed successfully for ${CERT_NAME}"

# Verify the renewed certificate
step certificate verify "${CERT_DIR}/${CERT_NAME}.crt" --roots "{{ smallstep_bin_dir }}/ca/certs/root_ca.crt"

{% if cert_item.post_renewal_hook is defined %}
# Execute post-renewal hook
echo "Executing post-renewal hook..."
{{ cert_item.post_renewal_hook }}
{% endif %}
