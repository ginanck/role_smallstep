#!/bin/bash

CA_URL="{{ smallstep_ca_server_url }}"
FINGERPRINT="{{ smallstep_ca_fingerprint }}"

set -e

# Detect OS distribution
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_FAMILY=$ID_LIKE
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
        OS_FAMILY="rhel"
    elif [ -f /etc/debian_version ]; then
        OS="debian"
        OS_FAMILY="debian"
    else
        echo "Unsupported OS"
        exit 1
    fi
}

# Detect architecture
ARCH=$(uname -m)
case "$ARCH" in
    x86_64)
        ARCH_NAME="amd64"
        ;;
    aarch64)
        ARCH_NAME="arm64"
        ;;
    armv7l)
        ARCH_NAME="armv7"
        ;;
    *)
        echo "[!] Unsupported architecture: $ARCH"
        exit 1
        ;;
esac

# Config
CA_CERT="root_ca.crt"
CLI_VERSION="{{ smallstep_cli_version }}"
CLI_ARCHIVE="step_linux_${CLI_VERSION}_${ARCH_NAME}.tar.gz"
CLI_URL="{{ smallstep_base_url }}/cli/releases/download/v${CLI_VERSION}/${CLI_ARCHIVE}"

echo "[*] Detected architecture: $ARCH_NAME"
echo "[*] Bootstrapping from: $CA_URL"
echo "[*] Fingerprint: $FINGERPRINT"

# Install step CLI if not present
if ! command -v step &> /dev/null; then
  echo "[*] Installing step CLI..."
  echo "[*] Downloading: $CLI_URL"
  
  # Download the CLI
  curl -LO "$CLI_URL"
  
  # Extract and install
  tar -xf "$CLI_ARCHIVE"
  sudo mv step_*/bin/step /usr/local/bin/
  sudo chmod +x /usr/local/bin/step
  sudo ln -sf /usr/local/bin/step /usr/bin/step
  
  # Cleanup
  rm -rf step_* step-* "$CLI_ARCHIVE"

  echo "[*] Step CLI installed successfully"
else
  echo "[*] Step CLI already installed"
fi

echo "[*] Bootstrapping Smallstep CA..."
step ca bootstrap --ca-url "$CA_URL" --fingerprint "$FINGERPRINT" --force --install

echo "[*] Installing CA to system trust store..."

# Detect OS and install certificate accordingly
detect_os

case "$OS" in
    ubuntu|debian)
        echo "[*] Detected Debian-based system"
        sudo cp ~/.step/certs/$CA_CERT /usr/local/share/ca-certificates/$CA_CERT
        sudo update-ca-certificates
        ;;
    centos|rhel|fedora|rocky|almalinux)
        echo "[*] Detected RHEL-based system"
        sudo cp ~/.step/certs/$CA_CERT /etc/pki/ca-trust/source/anchors/$CA_CERT
        sudo update-ca-trust
        ;;
    *)
        # Check OS family as fallback
        case "$OS_FAMILY" in
            *debian*)
                echo "[*] Detected Debian-like system"
                sudo cp ~/.step/certs/$CA_CERT /usr/local/share/ca-certificates/$CA_CERT
                sudo update-ca-certificates
                ;;
            *rhel*|*fedora*)
                echo "[*] Detected RHEL-like system"
                sudo cp ~/.step/certs/$CA_CERT /etc/pki/ca-trust/source/anchors/$CA_CERT
                sudo update-ca-trust
                ;;
            *)
                echo "[!] Unsupported distribution: $OS"
                echo "[!] Please manually install the certificate from ~/.step/certs/$CA_CERT"
                exit 1
                ;;
        esac
        ;;
esac

echo "[âœ“] Done! CA installed and trusted."
