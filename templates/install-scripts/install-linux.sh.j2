#!/bin/bash

set -e

# Detect OS distribution
detect_os() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        OS_FAMILY=$ID_LIKE
    elif [ -f /etc/redhat-release ]; then
        OS="rhel"
        OS_FAMILY="rhel"
    elif [ -f /etc/debian_version ]; then
        OS="debian"
        OS_FAMILY="debian"
    else
        echo "Unsupported OS"
        exit 1
    fi
}

# Config
CA_CERT="root_ca.crt"
ROOTS_URL="{{ smallstep_ca_server_url }}/roots.pem"

echo "[*] Downloading root CA certificate..."
echo "[*] Downloading from: $ROOTS_URL"

# Download the root CA certificate to current directory
curl -o "$CA_CERT" "$ROOTS_URL"
echo "[*] Certificate downloaded to: $CA_CERT"

echo "[*] Installing CA to system trust store..."

# Detect OS and install certificate accordingly
detect_os

case "$OS" in
    ubuntu|debian)
        echo "[*] Detected Debian-based system"
        sudo cp "$CA_CERT" "/usr/local/share/ca-certificates/$CA_CERT"
        sudo update-ca-certificates
        ;;
    centos|rhel|fedora|rocky|almalinux)
        echo "[*] Detected RHEL-based system"
        sudo cp "$CA_CERT" "/etc/pki/ca-trust/source/anchors/$CA_CERT"
        sudo update-ca-trust
        ;;
    *)
        # Check OS family as fallback
        case "$OS_FAMILY" in
            *debian*)
                echo "[*] Detected Debian-like system"
                sudo cp "$CA_CERT" "/usr/local/share/ca-certificates/$CA_CERT"
                sudo update-ca-certificates
                ;;
            *rhel*|*fedora*)
                echo "[*] Detected RHEL-like system"
                sudo cp "$CA_CERT" "/etc/pki/ca-trust/source/anchors/$CA_CERT"
                sudo update-ca-trust
                ;;
            *)
                echo "[!] Unsupported distribution: $OS"
                echo "[!] Please manually install the certificate from $CA_CERT"
                exit 1
                ;;
        esac
        ;;
esac

echo "[*] Cleaning up downloaded certificate file..."
rm "$CA_CERT"

echo "[âœ“] Done! CA installed and trusted."
echo "[*] Certificate file remains at: $CA_CERT"
