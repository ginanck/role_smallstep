# Config
$CA_CERT="root_ca.crt"
$ROOTS_URL = "{{ smallstep_ca_server_url }}/roots.pem"

Write-Host "[*] Downloading root CA certificate..." -ForegroundColor Yellow
Write-Host "[*] Downloading from: $ROOTS_URL" -ForegroundColor Yellow

try {
    # Download the root CA certificate to current directory
    Invoke-WebRequest -Uri $ROOTS_URL -OutFile $CA_CERT -UseBasicParsing
    Write-Host "[*] Certificate downloaded to: $CA_CERT" -ForegroundColor Green
    
    # Install CA to Windows Trusted Root store
    Write-Host "[*] Installing CA to Windows Trusted Root store..." -ForegroundColor Yellow
    Import-Certificate -FilePath $CA_CERT -CertStoreLocation Cert:\LocalMachine\Root | Out-Null
    Write-Host "[*] CA certificate imported successfully" -ForegroundColor Green
    
} catch {
    Write-Host "[!] Failed to download or install CA certificate: $_" -ForegroundColor Red
    exit 1
}

Write-Host "[*] Cleaning up downloaded certificate file..." -ForegroundColor Yellow
Remove-Item $CA_CERT -Force

Write-Host "[âœ“] Done! CA installed and trusted." -ForegroundColor Green
Write-Host "[*] Certificate file remains at: $CA_CERT" -ForegroundColor Yellow
